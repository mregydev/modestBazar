@if (product(); as currentProduct) {
  <div class="product-details">
    <a routerLink="/" class="back-link">{{ translate('productDetails.back') }}</a>

    <div class="product-layouts">
      <div class="product-main-content">
        <div class="product-image-section">
        <div class="image-carousel">
          <div class="image-zoom-container" (mouseenter)="onImageMouseEnter()" (mousemove)="onImageMouseMove($event)" (mouseleave)="onImageMouseLeave()">
            <img
              [src]="currentProduct.images[currentImageIndex()]"
              [alt]="currentProduct.name"
              class="product-image"
              loading="eager"
              fetchpriority="high"
            />
            <div class="zoom-lens" [class.active]="showZoomLens()" [style.left.px]="lensX()" [style.top.px]="lensY()"></div>
            <div class="zoom-result" [class.active]="showZoomLens()" [style.background-image]="'url(' + currentProduct.images[currentImageIndex()] + ')'" [style.background-position]="zoomBackgroundPosition()"></div>

            @if (currentProduct.images.length > 1) {
              <button
                class="carousel-btn prev"
                (click)="previousImage()"
                (mouseenter)="onCarouselButtonHover()"
                aria-label="Previous image"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
              </button>
              <button
                class="carousel-btn next"
                (click)="nextImage()"
                (mouseenter)="onCarouselButtonHover()"
                aria-label="Next image"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </button>
            }
          </div>

          @if (currentProduct.images.length > 0) {
            <div class="image-thumbnails">
              @for (image of currentProduct.images; track $index) {
                <button
                  class="thumbnail"
                  [class.active]="currentImageIndex() === $index"
                  (click)="goToImage($index)"
                  [attr.aria-label]="'View image ' + ($index + 1)"
                >
                  <img [src]="image" [alt]="currentProduct.name + ' - Image ' + ($index + 1)" loading="lazy" />
                </button>
              }
            </div>
          }
        </div>
      </div>

      <div class="product-info-section">
        <h1 class="product-name">{{ currentProduct.name }}</h1>
        @if (getStoreName(currentProduct) && getStoreSlug(currentProduct)) {
          <a
            [routerLink]="['/stores', getStoreSlug(currentProduct)]"
            class="store-link"
          >
            @if (getStoreLogoUrl(currentProduct)) {
              <img
                class="product-store-logo"
                [src]="getStoreLogoUrl(currentProduct)!"
                [alt]="getStoreName(currentProduct) + ' logo'"
              />
            }
            <span class="store-name">{{ getStoreName(currentProduct) }}</span>
          </a>
        }
        @if (currentProduct.rating) {
          <app-star-rating
            [rating]="currentProduct.rating"
            [reviewCount]="currentProduct.reviewCount || 0"
            [showReviewCount]="true"
            size="medium"
          ></app-star-rating>
        }
        <p class="product-price">{{ currentProduct.price }} {{ translate('common.egp') }}</p>

        <div class="description-section">
          <h3>{{ translate('productDetails.description') }}</h3>
          <p>{{ currentProduct.description }}</p>
        </div>

        <div class="modesty-attributes">
          <h3>{{ translate('productDetails.modestyAttributes') }}</h3>
          <div class="modesty-badges">
            @for (attr of currentProduct.modestyAttributes; track attr) {
              <span class="modesty-badge">{{ attr.replace('_', ' ') }}</span>
            }
          </div>
        </div>

        <div class="size-section">
          <h3>{{ translate('productDetails.sizeLength') }}</h3>
          <div class="size-guide-formatted">
            @for (sizeItem of getFormattedSizeGuide(currentProduct.sizeGuide); track sizeItem.size) {
              <div class="size-item">
                <span class="size-label">{{ sizeItem.size }}:</span>
                <span class="size-details">{{ sizeItem.details }}</span>
              </div>
            }
          </div>
          <div class="size-selector">
            <label for="size">{{ translate('productDetails.selectSize') }}</label>
            <select id="size" [(ngModel)]="selectedSize" (ngModelChange)="selectedSize.set($event)">
              <option value="S">S</option>
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
            </select>
          </div>
        </div>

        <div class="product-attributes-section">
          <h3>Product Details</h3>
          <div class="attributes-grid">
            @if (currentProduct.colors && currentProduct.colors.length > 0) {
              <div class="attribute-item">
                <strong>Colors:</strong>
                <div class="color-display">
                  @for (color of currentProduct.colors; track color) {
                    <span
                      class="color-badge"
                      [style.background-color]="getColorValue(color)"
                      [title]="color.charAt(0).toUpperCase() + color.slice(1)"
                    ></span>
                  }
                </div>
              </div>
            }
            @if (currentProduct.sizes && currentProduct.sizes.length > 0) {
              <div class="attribute-item">
                <strong>Available Sizes:</strong>
                <span>{{ currentProduct.sizes.join(', ') }}</span>
              </div>
            }
            @if (currentProduct.patternType) {
              <div class="attribute-item">
                <strong>Pattern:</strong>
                <span>{{ currentProduct.patternType }}</span>
              </div>
            }
            @if (currentProduct.material) {
              <div class="attribute-item">
                <strong>Material:</strong>
                <span>{{ currentProduct.material }}</span>
              </div>
            }
            @if (currentProduct.occasions && currentProduct.occasions.length > 0) {
              <div class="attribute-item">
                <strong>Occasions:</strong>
                <span>{{ currentProduct.occasions.join(', ') }}</span>
              </div>
            }
          </div>
        </div>

        <div class="extended-modesty-section">
          <h3>Modesty Details</h3>
          <div class="modesty-details-grid">
            @if (currentProduct.hijabFriendly) {
              <div class="modesty-detail-item">
                <strong>Hijab Friendly:</strong>
                <span>{{ currentProduct.hijabFriendly === 'yes' ? 'Yes' : currentProduct.hijabFriendly === 'maybe' ? 'Maybe' : 'No' }}</span>
              </div>
            }
            @if (currentProduct.sleeveLength) {
              <div class="modesty-detail-item">
                <strong>Sleeve Length:</strong>
                <span>{{ currentProduct.sleeveLength === 'threeQuarter' ? '3/4' : currentProduct.sleeveLength.charAt(0).toUpperCase() + currentProduct.sleeveLength.slice(1) }}</span>
              </div>
            }
            @if (currentProduct.necklineCoverage) {
              <div class="modesty-detail-item">
                <strong>Neckline Coverage:</strong>
                <span>{{ currentProduct.necklineCoverage.charAt(0).toUpperCase() + currentProduct.necklineCoverage.slice(1) }}</span>
              </div>
            }
            @if (currentProduct.lengthCategory) {
              <div class="modesty-detail-item">
                <strong>Length:</strong>
                <span>{{ currentProduct.lengthCategory.charAt(0).toUpperCase() + currentProduct.lengthCategory.slice(1) }}</span>
              </div>
            }
            @if (currentProduct.fit) {
              <div class="modesty-detail-item">
                <strong>Fit:</strong>
                <span>{{ currentProduct.fit.charAt(0).toUpperCase() + currentProduct.fit.slice(1) }}</span>
              </div>
            }
            @if (currentProduct.opacity) {
              <div class="modesty-detail-item">
                <strong>Opacity:</strong>
                <span>{{ currentProduct.opacity === 'opaque' ? 'Opaque' : 'Semi-sheer' }}</span>
              </div>
            }
            @if (currentProduct.slitCoverage) {
              <div class="modesty-detail-item">
                <strong>Slit Coverage:</strong>
                <span>{{ currentProduct.slitCoverage === 'noSlit' ? 'No slit' : currentProduct.slitCoverage === 'smallSideSlit' ? 'Small side slit' : 'High slit' }}</span>
              </div>
            }
          </div>
        </div>

        <a routerLink="/checkout" class="checkout-button">{{ translate('productDetails.checkout') }}</a>
        </div>
      </div>

      <!-- Matching Items -->
      @if (recommendations().length > 0) {
        <div class="carousel-section matching-items">
          <h3 class="carousel-title">{{ translate('productDetails.completeLook') }}</h3>
          <div class="recommendations-flex-container">
            @for (rec of recommendations(); track rec.id) {
              <div class="recommendation-card">
                <a [routerLink]="['/products', rec.id]" class="rec-link" (click)="scrollToTop()">
                  <img [src]="rec.images[0]" [alt]="rec.name" loading="lazy" />
                  <div class="rec-info">
                    <p class="rec-name">{{ rec.name }}</p>
                    <p class="rec-price">{{ rec.price }} {{ translate('common.egp') }}</p>
                  </div>
                </a>
                <label class="checkbox-label" (click)="$event.stopPropagation()">
                  <input
                    type="checkbox"
                    [checked]="isExtraSelected(rec.id)"
                    (change)="toggleExtra(rec.id); $event.stopPropagation()"
                    (click)="$event.stopPropagation()"
                  />
                  {{ translate('productDetails.addToOrder') }}
                </label>
              </div>
            }
          </div>
        </div>
      }

      @if (similarProducts().length > 0) {
        <div class="carousel-section matching-items">
          <h3 class="carousel-title">{{ translate('productDetails.similarProducts') }}</h3>
          <div class="recommendations-flex-container">
            @for (rec of similarProducts(); track rec.id) {
              <div class="recommendation-card">
                <a [routerLink]="['/products', rec.id]" class="rec-link" (click)="scrollToTop()">
                  <img [src]="rec.images[0]" [alt]="rec.name" loading="lazy" />
                  <div class="rec-info">
                    <p class="rec-name">{{ rec.name }}</p>
                    <p class="rec-price">{{ rec.price }} {{ translate('common.egp') }}</p>
                  </div>
                </a>
                <label class="checkbox-label" (click)="$event.stopPropagation()">
                  <input
                    type="checkbox"
                    [checked]="isExtraSelected(rec.id)"
                    (change)="toggleExtra(rec.id); $event.stopPropagation()"
                    (click)="$event.stopPropagation()"
                  />
                  {{ translate('productDetails.addToOrder') }}
                </label>
              </div>
            }
          </div>
        </div>
      }

    </div>
  </div>
} @else {
  <div class="no-product">
    <p>{{ translate('productDetails.notFound') }}</p>
    <a routerLink="/">{{ translate('productDetails.back') }}</a>
  </div>
}

